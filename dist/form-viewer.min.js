angular.module("mwFormViewer",["ngSanitize","ui.bootstrap","ng-sortable","pascalprecht.translate"]),angular.module("mwFormViewer").directive("mwPriorityList",function(){return{replace:!0,restrict:"AE",require:"^mwFormQuestion",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?"},templateUrl:"mw-priority-list.html",controllerAs:"ctrl",bindToController:!0,controller:function(){function e(e){if(e)for(var n=0;n<e.length;n++){var t=e[n];t.priority=n+1}}function n(e){e.sort(function(e,n){return e.priority-n.priority})}var t=this;this.$onInit=function(){t.questionResponse.priorityList||(t.questionResponse.priorityList=[]),t.idToItem={},n(t.questionResponse.priorityList),t.availableItems=[],t.question.priorityList.forEach(function(e){t.idToItem[e.id]=e;var n=t.questionResponse.priorityList.some(function(n){return e.id==n.id});n||t.availableItems.push({priority:null,id:e.id})}),t.allItemsOrdered=0==t.availableItems.length||null;var s={disabled:t.readOnly,ghostClass:"beingDragged"};t.orderedConfig=angular.extend({},s,{group:{name:"A",pull:!1,put:["B"]},onEnd:function(n,s){e(t.questionResponse.priorityList)}}),t.availableConfig=angular.extend({},s,{sort:!1,group:{name:"B",pull:["A"],put:!1},onEnd:function(n,s){e(t.questionResponse.priorityList),t.allItemsOrdered=0==t.availableItems.length||null}})},1===angular.version.major&&angular.version.minor<5&&this.$onInit()},link:function(e,n,t,s){var r=e.ctrl;r.print=s.print}}}),angular.module("mwFormViewer").directive("mwFormViewer",["$rootScope",function(e){return{replace:!0,restrict:"AE",scope:{formData:"=",responseData:"=",templateData:"=?",readOnly:"=?",options:"=?",formStatus:"=?",onSubmit:"&",api:"=?"},templateUrl:"mw-form-viewer.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","$interpolate",function(n,t){function s(){r.formData.pages.sort(function(e,n){return e.number-n.number})}var r=this;r.$onInit=function(){r.defaultOptions={nestedForm:!1,autoStart:!1,disableSubmit:!1},r.options=angular.extend({},r.defaultOptions,r.options),r.submitStatus="NOT_SUBMITTED",r.formSubmitted=!1,s(),r.pageIdToPage={},r.formData.pages.forEach(function(e){r.pageIdToPage[e.id]=e}),r.buttons={prevPage:{visible:!1,disabled:!1},nextPage:{visible:!1,disabled:!1},submitForm:{visible:!1,disabled:!1}},r.resetPages(),r.api&&(r.api.reset=function(){for(var e in r.responseData)r.responseData.hasOwnProperty(e)&&delete r.responseData[e];r.buttons.submitForm.visible=!1,r.buttons.prevPage.visible=!1,r.buttons.nextPage.visible=!1,r.currentPage=null,n(r.resetPages,0)})},r.submitForm=function(){r.formSubmitted=!0,r.submitStatus="IN_PROGRESS",r.setCurrentPage(null);var e=r.onSubmit();e.then(function(){r.submitStatus="SUCCESS"})["catch"](function(){r.submitStatus="ERROR"})},r.setCurrentPage=function(e){return r.currentPage=e,e?(r.setDefaultNextPage(),r.initResponsesForCurrentPage(),void r.updateShowSubQuestionBaseOnAnswers()):(r.buttons.submitForm.visible=!1,r.buttons.prevPage.visible=!1,void(r.buttons.nextPage.visible=!1))},r.setDefaultNextPage=function(){var e=r.formData.pages.indexOf(r.currentPage);if(r.currentPage.isFirst=0==e,r.currentPage.isLast=e==r.formData.pages.length-1,r.buttons.submitForm.visible=r.currentPage.isLast,r.buttons.prevPage.visible=!r.currentPage.isFirst,r.buttons.nextPage.visible=!r.currentPage.isLast,r.currentPage.isLast?r.nextPage=null:r.nextPage=r.formData.pages[e+1],r.currentPage.pageFlow){var n=!1;r.currentPage.pageFlow.formSubmit?(r.nextPage=null,n=!0):r.currentPage.pageFlow.page?(r.nextPage=r.pageIdToPage[r.currentPage.pageFlow.page.id],r.buttons.nextPage.visible=!0):r.currentPage.isLast&&(r.nextPage=null,n=!0),r.buttons.submitForm.visible=n,r.buttons.nextPage.visible=!n}},r.initResponsesForCurrentPage=function(){r.currentPage.elements.forEach(function(e){var n=e.question;n&&!r.responseData[n.id]&&(r.responseData[n.id]={})})},r.beginResponse=function(){r.formData.pages.length>0&&(r.setCurrentPage(r.formData.pages[0]),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:r.currentPage}))},r.resetPages=function(){r.prevPages=[],r.currentPage=null,r.nextPage=null,r.formSubmitted=!1,r.options.autoStart&&r.beginResponse()},r.goToPrevPage=function(){var n=r.prevPages.pop();r.setCurrentPage(n),r.updateNextPageBasedOnAllAnswers(),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:r.currentPage})},r.goToNextPage=function(){r.prevPages.push(r.currentPage),r.updateNextPageBasedOnAllAnswers(),r.setCurrentPage(r.nextPage),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:r.currentPage})},r.updateNextPageBasedOnAllAnswers=function(){r.currentPage.elements.forEach(function(e){r.updateNextPageBasedOnPageElementAnswers(e)}),r.buttons.submitForm.visible=!r.nextPage,r.buttons.nextPage.visible=!!r.nextPage},r.updateNextPageBasedOnPageElementAnswers=function(e){var n=e.question;n&&n.pageFlowModifier&&n.offeredAnswers.forEach(function(e){e.pageFlow&&r.responseData[n.id].selectedAnswer==e.id&&(e.pageFlow.formSubmit?r.nextPage=null:e.pageFlow.page&&(r.nextPage=r.pageIdToPage[e.pageFlow.page.id]))})},r.onResponseChanged=function(e){r.setDefaultNextPage(),r.updateNextPageBasedOnAllAnswers(),r.updateShowSubQuestionBaseOnAnswers()},r.updateShowSubQuestionBaseOnAnswers=function(){r.currentPage.elements.forEach(function(e){r.updateShowSubQuestionBaseOnAnswer(e)})},r.updateShowSubQuestionBaseOnAnswer=function(e){var n=e.question;n&&r.responseData[n.id]&&(r.responseData[n.id].subQuestions&&Object.keys(r.responseData[n.id].subQuestions).length>0&&(r.responseData[n.id].subQuestions={}),n&&n.showSubQuestionModifier&&n.offeredAnswers.forEach(function(e){r.responseData[n.id].selectedAnswer==e.id&&(n.showSubAnswers=!0,r.subQuestions=e.selectedSubQuestions)}))},r.onResponseChangedSubQuesion=function(e){void 0},r.print=function(e){return e&&r.templateData?t(e)(r.templateData):e},1===angular.version.major&&angular.version.minor<5&&r.$onInit()}],link:function(n,t,s){var r=n.ctrl;r.formStatus&&(r.formStatus.form=r.form),n.$on("mwForm.pageEvents.changePage",function(n,t){if("undefined"!=typeof t.page&&t.page<r.formData.pages.length){r.resetPages();for(var s=0;s<t.page;s++)r.prevPages.push(r.formData.pages[s]);var o=r.formData.pages[t.page];r.setCurrentPage(o),e.$broadcast("mwForm.pageEvents.pageCurrentChanged",{currentPage:o}),r.updateNextPageBasedOnAllAnswers(),r.updateShowSubQuestionBaseOnAnswers()}})}}}]),angular.module("mwFormViewer").factory("FormQuestionId",function(){var e=0;return{next:function(){return++e}}}).directive("mwFormQuestion",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{question:"=",questionResponse:"=",readOnly:"=?",options:"=?",onResponseChanged:"&?"},templateUrl:"mw-form-question.html",controllerAs:"ctrl",bindToController:!0,controller:["$timeout","FormQuestionId",function(e,n){var t=this;this.$onInit=function(){t.id=n.next(),"radio"==t.question.type?(t.questionResponse.selectedAnswer||(t.questionResponse.selectedAnswer=null),t.questionResponse.other&&(t.isOtherAnswer=!0),t.questionResponse.textAnswers||(t.questionResponse.textAnswers={})):"checkbox"==t.question.type?(t.questionResponse.selectedAnswers&&t.questionResponse.selectedAnswers.length?t.selectedAnswer=!0:t.questionResponse.selectedAnswers=[],t.questionResponse.other&&(t.isOtherAnswer=!0)):"grid"==t.question.type?t.question.grid.cellInputType||(t.question.grid.cellInputType="radio"):"division"==t.question.type?(t.computeDivisionSum=function(){t.divisionSum=0,t.question.divisionList.forEach(function(e){0==t.questionResponse[e.id]||t.questionResponse[e.id]?t.divisionSum+=t.questionResponse[e.id]:(t.questionResponse[e.id]=null,t.divisionSum+=0)})},t.computeDivisionSum()):"date"==t.question.type||"datetime"==t.question.type||"time"==t.question.type?t.questionResponse.answer&&(t.questionResponse.answer=new Date(t.questionResponse.answer)):"select"==t.question.type&&(t.questionResponse.textAnswers||(t.questionResponse.textAnswers={})),t.isAnswerSelected=!1,t.initialized=!0},t.selectedAnswerChanged=function(){delete t.questionResponse.other,t.isOtherAnswer=!1,t.answerChanged()},t.otherAnswerRadioChanged=function(){void 0,t.isOtherAnswer&&(t.questionResponse.selectedAnswer=null),t.answerChanged()},t.otherAnswerCheckboxChanged=function(){t.isOtherAnswer||delete t.questionResponse.other,t.selectedAnswer=!(!t.questionResponse.selectedAnswers.length&&!t.isOtherAnswer)||null,t.answerChanged()},t.toggleSelectedAnswer=function(e){t.questionResponse.selectedAnswers.indexOf(e.id)===-1?t.questionResponse.selectedAnswers.push(e.id):t.questionResponse.selectedAnswers.splice(t.questionResponse.selectedAnswers.indexOf(e.id),1),t.selectedAnswer=!(!t.questionResponse.selectedAnswers.length&&!t.isOtherAnswer)||null,t.answerChanged()},t.answerChanged=function(){t.onResponseChanged&&t.onResponseChanged()},1===angular.version.major&&angular.version.minor<5&&this.$onInit()}],link:function(e,n,t,s){var r=e.ctrl;r.print=s.print}}}),angular.module("mwFormViewer").directive("mwFormConfirmationPage",function(){return{replace:!0,restrict:"AE",require:"^mwFormViewer",scope:{submitStatus:"=",confirmationMessage:"=",readOnly:"=?"},templateUrl:"mw-form-confirmation-page.html",controllerAs:"ctrl",bindToController:!0,controller:function(){},link:function(e,n,t,s){var r=e.ctrl;r.print=s.print}}});